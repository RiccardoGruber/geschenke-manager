<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dev Test – Geschenk-Services</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>

<body class="bg-light">
  <div class="container py-4">
    <!-- HEADER -->
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h3 class="mb-0"><i class="bi bi-wrench-adjustable"></i> Dev Test – Geschenk-Services</h3>
      <div class="d-flex gap-2">
        <a class="btn btn-sm btn-outline-secondary" href="./login.html">
          <i class="bi bi-box-arrow-in-right"></i> Login
        </a>
        <a class="btn btn-sm btn-outline-secondary" href="./dashboard.html">
          <i class="bi bi-speedometer2"></i> Dashboard
        </a>
      </div>
    </div>

    <div class="alert alert-info" id="authBox">
      <i class="bi bi-info-circle"></i> Prüfe Login...
    </div>

    <!-- PERSON / IDS -->
    <div class="card mb-3">
      <div class="card-header fw-semibold">Person auswählen & Abhängigkeiten</div>
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-12 col-lg-5">
            <label class="form-label fw-semibold">Person</label>
            <select id="personSelect" class="form-select">
              <option value="">— Personen laden… —</option>
            </select>
            <div class="form-text">Wähle eine Person aus, um Ideen/Geschenke zuzuweisen.</div>
          </div>

          <div class="col-12 col-lg-3">
            <label class="form-label fw-semibold">Person-ID</label>
            <input id="personId" class="form-control" placeholder="personId" readonly>
            <div class="form-text">Wird automatisch gesetzt.</div>
          </div>

          <div class="col-12 col-lg-4 d-flex gap-2 flex-wrap">
            <button id="btnLoadPersons" class="btn btn-outline-primary" type="button">
              <i class="bi bi-people"></i> Personen laden
            </button>
            <button id="btnHasDeps" class="btn btn-outline-secondary" type="button">
              <i class="bi bi-diagram-3"></i> Abhängigkeiten prüfen
            </button>
            <button id="btnDeletePerson" class="btn btn-outline-danger" type="button">
              <i class="bi bi-trash"></i> Person löschen
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- CREATE IDEA -->
    <div class="card mb-3">
      <div class="card-header fw-semibold">Geschenkidee anlegen</div>
      <div class="card-body">
        <div class="row g-2">
          <div class="col-12 col-lg-4">
            <label class="form-label fw-semibold">Anlass</label>
            <select id="occasionSelect" class="form-select"></select>
          </div>

          <div class="col-12 col-lg-2">
            <label class="form-label fw-semibold">Typ</label>
            <select id="ideaType" class="form-select">
              <option value="text">Text</option>
              <option value="link">Link</option>
              <option value="image">Bild (URL)</option>
            </select>
          </div>

          <div class="col-12 col-lg-4">
            <label class="form-label fw-semibold">Inhalt</label>
            <input id="ideaContent" class="form-control" placeholder="z.B. Gutschein / Link / Bild-URL">
          </div>

          <div class="col-12 col-lg-2">
            <label class="form-label fw-semibold">Status</label>
            <select id="ideaStatus" class="form-select">
              <option value="offen">offen</option>
              <option value="besorgt">besorgt</option>
              <option value="erledigt">erledigt</option>
            </select>
          </div>
        </div>

        <div class="d-flex gap-2 flex-wrap mt-3">
          <button id="btnCreateIdea" class="btn btn-primary" type="button">
            <i class="bi bi-plus-circle"></i> Geschenkidee speichern
          </button>
          <button id="btnListIdeas" class="btn btn-outline-primary" type="button">
            <i class="bi bi-lightbulb"></i> Geschenkideen anzeigen
          </button>
        </div>
      </div>
    </div>

    <!-- IDEA ACTIONS -->
    <div class="card mb-3">
      <div class="card-header fw-semibold">Ideen-Aktionen</div>
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-12 col-lg-6">
            <label class="form-label fw-semibold">Idee auswählen</label>
            <select id="ideaSelect" class="form-select">
              <option value="">— erst „Geschenkideen anzeigen“ klicken —</option>
            </select>
          </div>

          <div class="col-12 col-lg-3">
            <label class="form-label fw-semibold">Neuer Ideen-Status</label>
            <select id="ideaStatusSelect" class="form-select">
              <option value="offen">offen</option>
              <option value="besorgt">besorgt</option>
              <option value="erledigt">erledigt</option>
            </select>
          </div>

          <div class="col-12 col-lg-3 d-flex gap-2 flex-wrap">
            <button id="btnSetIdeaStatus" class="btn btn-warning" type="button">
              <i class="bi bi-check2-circle"></i> Status setzen
            </button>
            <button id="btnDeleteIdea" class="btn btn-danger" type="button">
              <i class="bi bi-trash"></i> Idee löschen
            </button>
            <button id="btnConvert" class="btn btn-success" type="button">
              <i class="bi bi-arrow-repeat"></i> In Geschenk umwandeln
            </button>
          </div>
        </div>
        <div class="form-text mt-2">
          „In Geschenk umwandeln“ übernimmt Anlass/Person und setzt die Idee auf erledigt.
        </div>
      </div>
    </div>

    <!-- ✅ TEILEN PER LINK (TF-46..48) -->
    <div class="card mb-3">
      <div class="card-header fw-semibold d-flex align-items-center justify-content-between">
        <span><i class="bi bi-share"></i> Teilen per Link (TF-46–TF-48)</span>
        <a class="btn btn-sm btn-outline-secondary" href="./share.html" target="_blank">
          <i class="bi bi-box-arrow-up-right"></i> share.html öffnen
        </a>
      </div>
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-12 col-lg-4">
            <label class="form-label fw-semibold">TTL (Tage)</label>
            <input id="shareTtlDays" class="form-control" type="number" min="1" value="30">
            <div class="form-text">Nach Ablauf zeigt share.html „abgelaufen“ (TF-48).</div>
          </div>

          <div class="col-12 col-lg-8 d-flex gap-2 flex-wrap">
            <button id="btnSharePersonIdeas" class="btn btn-primary" type="button">
              <i class="bi bi-people"></i> Link für Person-Ideen erzeugen
            </button>
            <button id="btnShareSingleIdea" class="btn btn-success" type="button">
              <i class="bi bi-lightbulb"></i> Link für ausgewählte Idee erzeugen
            </button>
            <button id="btnOpenShareLink" class="btn btn-outline-secondary" type="button">
              <i class="bi bi-box-arrow-up-right"></i> Link öffnen
            </button>
          </div>
        </div>

        <div class="mt-3">
          <label class="form-label fw-semibold">Erzeugter Share-Link</label>
          <input id="shareLinkOut" class="form-control" readonly placeholder="Hier erscheint der Link…">
          <div class="form-text">
            Der Link wird automatisch in die Zwischenablage kopiert (wenn erlaubt).
            Test TF-48: ändere 1 Zeichen im Token oder setze TTL=1 und warte/ändere expiresAt.
          </div>
        </div>
      </div>
    </div>

    <!-- GIFTS -->
    <div class="card mb-3">
      <div class="card-header fw-semibold">Geschenke (geplant)</div>
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-12 col-lg-6">
            <label class="form-label fw-semibold">Geschenk auswählen</label>
            <select id="giftSelect" class="form-select">
              <option value="">— erst „Geschenke anzeigen“ klicken —</option>
            </select>
          </div>

          <div class="col-12 col-lg-3">
            <label class="form-label fw-semibold">Neuer Geschenk-Status</label>
            <select id="giftStatusSelect" class="form-select">
              <option value="offen">offen</option>
              <option value="besorgt">besorgt</option>
              <option value="ueberreicht">ueberreicht</option>
            </select>
          </div>

          <div class="col-12 col-lg-3 d-flex gap-2 flex-wrap">
            <button id="btnListGifts" class="btn btn-outline-success" type="button">
              <i class="bi bi-gift"></i> Geschenke anzeigen
            </button>
            <button id="btnSetGiftStatus" class="btn btn-warning" type="button">
              <i class="bi bi-check2-circle"></i> Status setzen
            </button>
            <button id="btnDeleteGift" class="btn btn-danger" type="button">
              <i class="bi bi-trash"></i> Geschenk löschen
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- PAST GIFTS (CRUD + TF-10/11/12) -->
    <div class="card mb-3">
      <div class="card-header fw-semibold">Vergangene Geschenke (Historie)</div>
      <div class="card-body">
        <div class="row g-2">
          <div class="col-12 col-lg-4">
            <label class="form-label fw-semibold">Anlass</label>
            <select id="pastOccasionSelect" class="form-select"></select>
          </div>

          <div class="col-12 col-lg-3">
            <label class="form-label fw-semibold">Datum</label>
            <input id="pastDate" class="form-control" placeholder="YYYY-MM-DD">
          </div>

          <div class="col-12 col-lg-5">
            <label class="form-label fw-semibold">Notiz</label>
            <input id="pastNote" class="form-control" placeholder="z.B. was genau geschenkt wurde">
          </div>
        </div>

        <div class="d-flex gap-2 flex-wrap mt-3">
          <button id="btnCreatePast" class="btn btn-primary" type="button">
            <i class="bi bi-plus-circle"></i> Vergangenes Geschenk speichern
          </button>
          <button id="btnListPast" class="btn btn-outline-primary" type="button">
            <i class="bi bi-clock-history"></i> Historie (pro Person) anzeigen
          </button>
        </div>

        <hr class="my-3">

        <div class="row g-2 align-items-end">
          <div class="col-12 col-lg-8">
            <label class="form-label fw-semibold">Vergangenes Geschenk auswählen</label>
            <select id="pastGiftSelect" class="form-select">
              <option value="">— erst „Historie anzeigen“ klicken —</option>
            </select>
          </div>
          <div class="col-12 col-lg-4 d-flex gap-2 flex-wrap">
            <button id="btnUpdatePast" class="btn btn-warning" type="button">
              <i class="bi bi-pencil"></i> Bearbeiten (Datum/Notiz/Anlass)
            </button>
            <button id="btnDeletePast" class="btn btn-danger" type="button">
              <i class="bi bi-trash"></i> Löschen
            </button>
          </div>
        </div>

        <div class="form-text mt-2">
          Bearbeiten nutzt die Eingabefelder oben (Datum/Notiz/Anlass) als Patch.
        </div>
      </div>
    </div>

    <!-- OUTPUT TABLES -->
    <div class="row g-3">
      <div class="col-12 col-lg-6">
        <div class="card">
          <div class="card-header fw-semibold">Geschenkideen (Tabelle)</div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm align-middle" id="ideasTable">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Anlass</th>
                    <th>Typ</th>
                    <th>Status</th>
                    <th>Inhalt</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="text-muted">Noch keine Daten.</td></tr>
                </tbody>
              </table>
            </div>
            <div class="form-text">Hier sieht man es „normal“ – nicht als JSON-Code.</div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card">
          <div class="card-header fw-semibold">Geschenke (geplant) (Tabelle)</div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm align-middle" id="giftsTable">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Anlass</th>
                    <th>Status</th>
                    <th>Datum</th>
                    <th>Notiz</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="6" class="text-muted">Noch keine Daten.</td></tr>
                </tbody>
              </table>
            </div>
            <div class="form-text">Hier sieht man es „normal“ – nicht als JSON-Code.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- TF-13 Gesamtübersicht vergangene Geschenke -->
    <div class="card mt-3">
      <div class="card-header fw-semibold d-flex align-items-center justify-content-between">
        <span>TF-13 – Gesamtübersicht: vergangene Geschenke (Tabelle)</span>
        <button id="btnListPastAll" class="btn btn-sm btn-outline-primary" type="button">
          <i class="bi bi-list-ul"></i> Gesamtübersicht laden
        </button>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm align-middle" id="pastAllTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Person</th>
                <th>Anlass</th>
                <th>Datum</th>
                <th>Status</th>
                <th>Notiz</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" class="text-muted">Noch keine Daten.</td></tr>
            </tbody>
          </table>
        </div>
        <div class="form-text">
          Diese Ansicht lädt alle vergangenen Geschenke des Users (unabhängig von der ausgewählten Person).
        </div>
      </div>
    </div>

    <p class="text-muted small mt-3">
      Tipp: Falls etwas fehlschlägt, öffne die Browser-Konsole (F12) für Details.
    </p>
  </div>

  <script type="module">
    // Core
    import "./js/firebase-config.js";
    import { waitForUserOnce } from "./js/auth-adapter.js";

    // Services
    import { listPersons, deletePerson } from "./js/person-service.js";
    import { ensureDefaultOccasions, listOccasions } from "./js/occasion-service.js";

    import {
      createGiftIdea,
      listGiftIdeas,
      setGiftIdeaStatus,
      deleteGiftIdea,
      hasGiftIdeasByPerson
    } from "./js/gift-idea-service.js";

    import {
      listGifts,
      setGiftStatus,
      deleteGift,
      hasGiftsByPerson,
      createPastGift,
      listPastGifts,
      listPastGiftsByPerson,
      updatePastGift,
      deletePastGift
    } from "./js/gift-service.js";

    import { convertIdeaToGift } from "./js/gift-convert.js";

    // ✅ Share
    import {
      createShareLinkGiftIdeasByPerson,
      createShareLinkGiftIdea
    } from "./js/share-service.js";

    // ---------------- UI refs ----------------
    const authBox = document.getElementById("authBox");

    const personSelect = document.getElementById("personSelect");
    const personIdInput = document.getElementById("personId");

    const occasionSelect = document.getElementById("occasionSelect");
    const ideaType = document.getElementById("ideaType");
    const ideaContent = document.getElementById("ideaContent");
    const ideaStatus = document.getElementById("ideaStatus");

    const ideaSelect = document.getElementById("ideaSelect");
    const giftSelect = document.getElementById("giftSelect");

    const ideaStatusSelect = document.getElementById("ideaStatusSelect");
    const giftStatusSelect = document.getElementById("giftStatusSelect");

    const pastOccasionSelect = document.getElementById("pastOccasionSelect");
    const pastDate = document.getElementById("pastDate");
    const pastNote = document.getElementById("pastNote");
    const pastGiftSelect = document.getElementById("pastGiftSelect");

    // Share refs
    const shareTtlDays = document.getElementById("shareTtlDays");
    const shareLinkOut = document.getElementById("shareLinkOut");

    const ideasTable = document.getElementById("ideasTable").querySelector("tbody");
    const giftsTable = document.getElementById("giftsTable").querySelector("tbody");
    const pastAllTable = document.getElementById("pastAllTable").querySelector("tbody");

    function setAuthBox(type, html) {
      authBox.className = "alert alert-" + type;
      authBox.innerHTML = html;
    }

    async function requireLogin() {
      const u = await waitForUserOnce();
      if (!u) {
        setAuthBox("warning", '<i class="bi bi-exclamation-triangle"></i> Nicht eingeloggt. Bitte zuerst einloggen.');
        throw new Error("Not logged in");
      }
      setAuthBox("success", '<i class="bi bi-check-circle"></i> Eingeloggt als: <strong>' + (u.email || u.uid) + '</strong>');
      return u;
    }

    function todayYYYYMMDD() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function clearTable(tbody, colspan) {
      tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-muted">Keine Daten vorhanden.</td></tr>`;
    }

    function renderIdeasTable(items) {
      if (!items || items.length === 0) return clearTable(ideasTable, 5);
      ideasTable.innerHTML = items.map(i => `
        <tr>
          <td class="text-muted">${i.id}</td>
          <td>${i.occasionName || "—"}</td>
          <td>${i.type || "—"}</td>
          <td><span class="badge bg-light text-dark">${i.status || "—"}</span></td>
          <td>${(i.content || "").toString().slice(0, 80)}</td>
        </tr>
      `).join("");
    }

    function renderGiftsTable(items, ideaContentById) {
      if (!items || items.length === 0) return clearTable(giftsTable, 6);

      giftsTable.innerHTML = items.map(g => {
        const nameFromIdea = (g.sourceIdeaId && ideaContentById && ideaContentById[g.sourceIdeaId]) ? ideaContentById[g.sourceIdeaId] : "";
        const displayName =
          (g.name || g.title || "").trim() ||
          (nameFromIdea || "").trim() ||
          "—";

        return `
          <tr>
            <td class="text-muted">${g.id}</td>
            <td>${String(displayName).slice(0, 60)}</td>
            <td>${g.occasionName || "—"}</td>
            <td><span class="badge bg-light text-dark">${g.status || "—"}</span></td>
            <td>${g.date || "—"}</td>
            <td>${(g.note || "").toString().slice(0, 80)}</td>
          </tr>
        `;
      }).join("");
    }

    function renderPastAllTable(items) {
      if (!items || items.length === 0) return clearTable(pastAllTable, 6);

      pastAllTable.innerHTML = items.map(x => `
        <tr>
          <td class="text-muted">${x.id}</td>
          <td>${x.personName || x.personId || "—"}</td>
          <td>${x.occasionName || "—"}</td>
          <td>${x.date || "—"}</td>
          <td><span class="badge bg-light text-dark">${x.status || "—"}</span></td>
          <td>${(x.note || "").toString().slice(0, 80)}</td>
        </tr>
      `).join("");
    }

    function fillSelect(select, items, getValue, getLabel, emptyLabel) {
      select.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = emptyLabel || "— auswählen —";
      select.appendChild(opt0);

      items.forEach(x => {
        const opt = document.createElement("option");
        opt.value = getValue(x);
        opt.textContent = getLabel(x);
        select.appendChild(opt);
      });
    }

    async function loadOccasions() {
      await ensureDefaultOccasions();
      const occ = await listOccasions();

      fillSelect(
        occasionSelect,
        occ,
        o => o.id,
        o => `${o.name || "Anlass"}${o.type ? " (" + o.type + ")" : ""}`,
        "— Anlass auswählen —"
      );

      fillSelect(
        pastOccasionSelect,
        occ,
        o => o.id,
        o => `${o.name || "Anlass"}${o.type ? " (" + o.type + ")" : ""}`,
        "— Anlass auswählen —"
      );

      return occ;
    }

    async function loadPersons() {
      const persons = await listPersons();
      fillSelect(
        personSelect,
        persons,
        p => p.id,
        p => `${p.name || "—"}  •  ${p.id}`,
        "— Person auswählen —"
      );
      return persons;
    }

    function getSelectedPersonId() {
      const pid = personSelect.value || "";
      personIdInput.value = pid;
      return pid;
    }

    async function listIdeasForPerson(pid) {
      const all = await listGiftIdeas();
      const filtered = all.filter(i => i.personId === pid);

      fillSelect(
        ideaSelect,
        filtered,
        i => i.id,
        i => `${i.occasionName || "Anlass"} • ${i.status || "—"} • ${String(i.content || "").slice(0, 30)}`,
        "— Idee auswählen —"
      );

      renderIdeasTable(filtered);
      return filtered;
    }

    async function listGiftsForPerson(pid) {
      const [allGifts, allIdeas] = await Promise.all([listGifts(), listGiftIdeas()]);
      const filtered = allGifts.filter(g => g.personId === pid);

      const ideaContentById = {};
      allIdeas.forEach(i => { ideaContentById[i.id] = i.content || ""; });

      fillSelect(
        giftSelect,
        filtered,
        g => g.id,
        g => {
          const nameFromIdea = (g.sourceIdeaId && ideaContentById[g.sourceIdeaId]) ? ideaContentById[g.sourceIdeaId] : "";
          const displayName = (g.name || g.title || "").trim() || (nameFromIdea || "").trim() || "—";
          return `${displayName.slice(0, 30)} • ${g.occasionName || "Anlass"} • ${g.status || "—"} • ${g.date || "—"}`;
        },
        "— Geschenk auswählen —"
      );

      renderGiftsTable(filtered, ideaContentById);
      return filtered;
    }

    async function listPastForPerson(pid) {
      const items = await listPastGiftsByPerson(pid);

      fillSelect(
        pastGiftSelect,
        items,
        x => x.id,
        x => `${x.occasionName || "Anlass"} • ${x.date || "—"} • ${(x.note || "").slice(0, 30)}`,
        "— Vergangenes Geschenk auswählen —"
      );

      return items;
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (e) {
        console.warn("Clipboard nicht verfügbar:", e);
        return false;
      }
    }

    // ---------------- Events ----------------
    document.getElementById("btnLoadPersons").addEventListener("click", async () => {
      try {
        await requireLogin();
        await loadPersons();
        await loadOccasions();
        setAuthBox("success", authBox.innerHTML + "<br><small>Personen/Anlässe geladen.</small>");
      } catch (e) {
        console.error(e);
      }
    });

    personSelect.addEventListener("change", async () => {
      try {
        await requireLogin();
        const pid = getSelectedPersonId();
        if (!pid) return;
        await listIdeasForPerson(pid);
        await listGiftsForPerson(pid);
        await listPastForPerson(pid);
      } catch (e) {
        console.error(e);
      }
    });

    // ✅ SHARE: Link für alle Ideen der Person
    document.getElementById("btnSharePersonIdeas").addEventListener("click", async () => {
      try {
        await requireLogin();
        const pid = getSelectedPersonId();
        if (!pid) return alert("Bitte zuerst eine Person auswählen.");

        const personName = (personSelect.options[personSelect.selectedIndex]?.textContent || "").split("•")[0]?.trim();
        const ttl = Number(shareTtlDays.value || 30);

        const link = await createShareLinkGiftIdeasByPerson({ personId: pid, personName, ttlDays: ttl });
        shareLinkOut.value = link;

        const ok = await copyToClipboard(link);
        alert(ok ? "✅ Link kopiert:\n" + link : "Link erstellt (Clipboard nicht erlaubt):\n" + link);
      } catch (e) {
        console.error(e);
        alert("Fehler: " + (e?.message || e));
      }
    });

    // ✅ SHARE: Link für ausgewählte Idee
    document.getElementById("btnShareSingleIdea").addEventListener("click", async () => {
      try {
        await requireLogin();
        const id = ideaSelect.value;
        if (!id) return alert("Bitte zuerst eine Idee auswählen.");

        const ttl = Number(shareTtlDays.value || 30);

        const link = await createShareLinkGiftIdea({ ideaId: id, ttlDays: ttl });
        shareLinkOut.value = link;

        const ok = await copyToClipboard(link);
        alert(ok ? "✅ Link kopiert:\n" + link : "Link erstellt (Clipboard nicht erlaubt):\n" + link);
      } catch (e) {
        console.error(e);
        alert("Fehler: " + (e?.message || e));
      }
    });

    // ✅ SHARE: Link öffnen
    document.getElementById("btnOpenShareLink").addEventListener("click", async () => {
      const link = (shareLinkOut.value || "").trim();
      if (!link) return alert("Bitte zuerst einen Link erzeugen.");
      window.open(link, "_blank");
    });

    document.getElementById("btnHasDeps").addEventListener("click", async () => {
      try {
        await requireLogin();
        const pid = getSelectedPersonId();
        if (!pid) return alert("Bitte zuerst eine Person auswählen.");

        const [hasIdeas, hasGifts] = await Promise.all([
          hasGiftIdeasByPerson(pid),
          hasGiftsByPerson(pid)
        ]);

        alert(`Abhängigkeiten:\n- Geschenkideen: ${hasIdeas ? "JA" : "NEIN"}\n- Geschenke (inkl. vergangene): ${hasGifts ? "JA" : "NEIN"}`);
      } catch (e) {
        console.error(e);
        alert("Fehler beim Prüfen: " + (e?.message || e));
      }
    });

    document.getElementById("btnDeletePerson").addEventListener("click", async () => {
      try {
        await requireLogin();
        const pid = getSelectedPersonId();
        if (!pid) return alert("Bitte zuerst eine Person auswählen.");
        if (!confirm("Person wirklich löschen?")) return;

        const [hasIdeas, hasGifts] = await Promise.all([
          hasGiftIdeasByPerson(pid),
          hasGiftsByPerson(pid)
        ]);

        if (hasIdeas || hasGifts) {
          alert("Diese Person kann nicht gelöscht werden, weil Geschenkideen oder Geschenke existieren.");
          return;
        }

        await deletePerson(pid);
        alert("Person gelöscht.");

        await loadPersons();
        personSelect.value = "";
        personIdInput.value = "";
        clearTable(ideasTable, 5);
        clearTable(giftsTable, 6);
        clearTable(pastAllTable, 6);
        ideaSelect.innerHTML = '<option value="">— Idee auswählen —</option>';
        giftSelect.innerHTML = '<option value="">— Geschenk auswählen —</option>';
        pastGiftSelect.innerHTML = '<option value="">— Vergangenes Geschenk auswählen —</option>';
      } catch (e) {
        console.error(e);
        alert("Fehler beim Löschen: " + (e?.message || e));
      }
    });

    document.getElementById("btnCreateIdea").addEventListener("click", async () => {
      try {
        await requireLogin();
        const pid = getSelectedPersonId();
        if (!pid) return alert("Bitte zuerst eine Person auswählen.");

        const occId = occasionSelect.value;
        const occName = occasionSelect.options[occasionSelect.selectedIndex]?.textContent || "—";

        const content = (ideaContent.value || "").trim();
        if (!content) return alert("Bitte Inhalt für die Geschenkidee eingeben.");

        await createGiftIdea({
          personId: pid,
          personName: (personSelect.options[personSelect.selectedIndex]?.textContent || "").split("•")[0]?.trim() || "",
          occasionId: occId || "",
          occasionName: occName || "",
          type: ideaType.value,
          content,
          status: ideaStatus.value
        });

        ideaContent.value = "";
        await listIdeasForPerson(pid);
        await listGiftsForPerson(pid);
        alert("Geschenkidee gespeichert.");
      } catch (e) {
        console.error(e);
        alert("Fehler: " + (e?.message || e));
      }
    });

    document.getElementById("btnListIdeas").addEventListener("click", async () => {
      try {
        await requireLogin();
        const pid = getSelectedPersonId();
        if (!pid) return alert("Bitte zuerst eine Person auswählen.");
        await listIdeasForPerson(pid);
      } catch (e) {
        console.error(e);
      }
    });

    document.getElementById("btnDeleteIdea").addEventListener("click", async () => {
      try {
        await requireLogin();
        const pid = getSelectedPersonId();
        if (!pid) return alert("Bitte zuerst eine Person auswählen.");
        const id = ideaSelect.value;
        if (!id) return alert("Bitte zuerst eine Idee auswählen.");
        if (!confirm("Idee wirklich löschen?")) return;

        await deleteGiftIdea(id);
        await listIdeasForPerson(pid);
        await listGiftsForPerson(pid);
        alert("Idee gelöscht.");
      } catch (e) {
        console.error(e);
        alert("Fehler: " + (e?.message || e));
      }
    });

    document.getElementById("btnSetIdeaStatus").addEventListener("click", async () => {
      try {
        await requireLogin();
        const pid = getSelectedPersonId();
        if (!pid) return alert("Bitte zuerst eine Person auswählen.");
        const id = ideaSelect.value;
        if (!id) return alert("Bitte zuerst eine Idee auswählen.");

        const newStatus = ideaStatusSelect.value;
        await setGiftIdeaStatus(id, newStatus);

        await listIdeasForPerson(pid);
        await listGiftsForPerson(pid);
        alert("Ideenstatus gesetzt auf: " + newStatus);
      } catch (e) {
        console.error(e);
        alert("Fehler: " + (e?.message || e));
      }
    });

    document.getElementById("btnConvert").addEventListener("click", async () => {
      try {
        await requireLogin();
        const pid = getSelectedPersonId();
        if (!pid) return alert("Bitte zuerst eine Person auswählen.");
        const id = ideaSelect.value;
        if (!id) return alert("Bitte zuerst eine Idee auswählen.");

        await convertIdeaToGift(id, { date: todayYYYYMMDD(), note: "Konvertiert (Dev-Test)" });

        await listIdeasForPerson(pid);
        await listGiftsForPerson(pid);
        alert("Idee wurde in Geschenk umgewandelt.");
      } catch (e) {
        console.error(e);
        alert("Fehler beim Umwandeln: " + (e?.message || e));
      }
    });

    document.getElementById("btnListGifts").addEventListener("click", async () => {
      try {
        await requireLogin();
        const pid = getSelectedPersonId();
        if (!pid) return alert("Bitte zuerst eine Person auswählen.");
        await listGiftsForPerson(pid);
      } catch (e) {
        console.error(e);
      }
    });

    document.getElementById("btnSetGiftStatus").addEventListener("click", async () => {
      try {
        await requireLogin();
        const pid = getSelectedPersonId();
        if (!pid) return alert("Bitte zuerst eine Person auswählen.");
        const id = giftSelect.value;
        if (!id) return alert("Bitte zuerst ein Geschenk auswählen.");

        const newStatus = giftStatusSelect.value;
        await setGiftStatus(id, newStatus);

        await listGiftsForPerson(pid);
        alert("Geschenkstatus gesetzt auf: " + newStatus);
      } catch (e) {
        console.error(e);
        alert("Fehler: " + (e?.message || e));
      }
    });

    document.getElementById("btnDeleteGift").addEventListener("click", async () => {
      try {
        await requireLogin();
        const pid = getSelectedPersonId();
        if (!pid) return alert("Bitte zuerst eine Person auswählen.");
        const id = giftSelect.value;
        if (!id) return alert("Bitte zuerst ein Geschenk auswählen.");
        if (!confirm("Geschenk wirklich löschen?")) return;

        await deleteGift(id);
        await listGiftsForPerson(pid);
        alert("Geschenk gelöscht.");
      } catch (e) {
        console.error(e);
        alert("Fehler: " + (e?.message || e));
      }
    });

    // Past gifts CRUD
    document.getElementById("btnCreatePast").addEventListener("click", async () => {
      try {
        await requireLogin();
        const pid = getSelectedPersonId();
        if (!pid) return alert("Bitte zuerst eine Person auswählen.");

        const occId = pastOccasionSelect.value;
        const occName = pastOccasionSelect.options[pastOccasionSelect.selectedIndex]?.textContent || "—";

        const date = (pastDate.value || "").trim();
        const note = (pastNote.value || "").trim();
        if (!date) return alert("Bitte Datum angeben (YYYY-MM-DD).");

        await createPastGift({
          personId: pid,
          personName: (personSelect.options[personSelect.selectedIndex]?.textContent || "").split("•")[0]?.trim() || "",
          occasionId: occId || "",
          occasionName: occName || "",
          date,
          note,
          status: "ueberreicht"
        });

        pastNote.value = "";
        await listPastForPerson(pid);
        alert("Vergangenes Geschenk gespeichert.");
      } catch (e) {
        console.error(e);
        alert("Fehler: " + (e?.message || e));
      }
    });

    document.getElementById("btnListPast").addEventListener("click", async () => {
      try {
        await requireLogin();
        const pid = getSelectedPersonId();
        if (!pid) return alert("Bitte zuerst eine Person auswählen.");
        await listPastForPerson(pid);
      } catch (e) {
        console.error(e);
      }
    });

    document.getElementById("btnUpdatePast").addEventListener("click", async () => {
      try {
        await requireLogin();
        const pid = getSelectedPersonId();
        if (!pid) return alert("Bitte zuerst eine Person auswählen.");
        const id = pastGiftSelect.value;
        if (!id) return alert("Bitte zuerst ein vergangenes Geschenk auswählen.");

        const occId = pastOccasionSelect.value;
        const occName = pastOccasionSelect.options[pastOccasionSelect.selectedIndex]?.textContent || "—";

        const date = (pastDate.value || "").trim();
        const note = (pastNote.value || "").trim();

        const patch = {};
        if (occId) patch.occasionId = occId;
        if (occName) patch.occasionName = occName;
        if (date) patch.date = date;
        patch.note = note;

        await updatePastGift(id, patch);
        await listPastForPerson(pid);
        alert("Vergangenes Geschenk aktualisiert.");
      } catch (e) {
        console.error(e);
        alert("Fehler: " + (e?.message || e));
      }
    });

    document.getElementById("btnDeletePast").addEventListener("click", async () => {
      try {
        await requireLogin();
        const pid = getSelectedPersonId();
        if (!pid) return alert("Bitte zuerst eine Person auswählen.");
        const id = pastGiftSelect.value;
        if (!id) return alert("Bitte zuerst ein vergangenes Geschenk auswählen.");
        if (!confirm("Vergangenes Geschenk wirklich löschen?")) return;

        await deletePastGift(id);
        await listPastForPerson(pid);
        alert("Vergangenes Geschenk gelöscht.");
      } catch (e) {
        console.error(e);
        alert("Fehler: " + (e?.message || e));
      }
    });

    // TF-13 Gesamtübersicht
    document.getElementById("btnListPastAll").addEventListener("click", async () => {
      try {
        await requireLogin();
        const items = await listPastGifts();
        renderPastAllTable(items);
        alert(`TF-13: ${items.length} vergangene Geschenke geladen.`);
      } catch (e) {
        console.error(e);
        alert("Fehler: " + (e?.message || e));
      }
    });

    // Init
    (async () => {
      try {
        await requireLogin();
        await loadOccasions();
        setAuthBox("success", authBox.innerHTML + "<br><small>Bereit. Klicke „Personen laden“.</small>");
      } catch (e) {
        // authBox wurde bereits gesetzt
      }
    })();
  </script>
</body>
</html>
